<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AC Elite - Simracing Community</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      .font-racing {
        font-family: "Orbitron", sans-serif;
      }
      .font-body {
        font-family: "Inter", sans-serif;
      }
      .gold-gradient {
        background: linear-gradient(
          135deg,
          #d4af37 0%,
          #f4e076 50%,
          #d4af37 100%
        );
      }
      .blue-gradient {
        background: linear-gradient(
          135deg,
          #0c1929 0%,
          #1e3a5f 50%,
          #0c1929 100%
        );
      }
      .glow {
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
      }
      .top1 {
        background: linear-gradient(
          90deg,
          rgba(255, 215, 0, 0.15) 0%,
          transparent 100%
        );
        border-left: 4px solid #ffd700;
      }
      .top2 {
        background: linear-gradient(
          90deg,
          rgba(192, 192, 192, 0.15) 0%,
          transparent 100%
        );
        border-left: 4px solid #c0c0c0;
      }
      .top3 {
        background: linear-gradient(
          90deg,
          rgba(205, 127, 50, 0.15) 0%,
          transparent 100%
        );
        border-left: 4px solid #cd7f32;
      }
      .top10 {
        background: linear-gradient(
          90deg,
          rgba(59, 130, 246, 0.1) 0%,
          transparent 100%
        );
        border-left: 4px solid #3b82f6;
      }
      .licence-platinum {
        background: linear-gradient(
          135deg,
          #e5e4e2 0%,
          #a0a0a0 50%,
          #e5e4e2 100%
        );
      }
      .licence-gold {
        background: linear-gradient(
          135deg,
          #d4af37 0%,
          #f4e076 50%,
          #d4af37 100%
        );
      }
      .licence-silver {
        background: linear-gradient(
          135deg,
          #c0c0c0 0%,
          #e8e8e8 50%,
          #c0c0c0 100%
        );
      }
      .licence-bronze {
        background: linear-gradient(
          135deg,
          #cd7f32 0%,
          #e6a86c 50%,
          #cd7f32 100%
        );
      }

      .autocomplete-container {
        position: relative;
      }
      .autocomplete-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 0.5rem;
        max-height: 300px;
        overflow-y: auto;
        z-index: 50;
        display: none;
      }
      .autocomplete-results.show {
        display: block;
      }
      .autocomplete-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #334155;
      }
      .autocomplete-item:hover {
        background: #334155;
      }
      .autocomplete-item:last-child {
        border-bottom: none;
      }
      .autocomplete-name {
        font-weight: 600;
        color: #fff;
      }
      .autocomplete-guid {
        font-size: 0.75rem;
        color: #64748b;
        font-family: monospace;
      }
    </style>
  </head>
  <body class="font-body bg-slate-950 text-white min-h-screen">
    <!-- Navigation -->
    <nav class="blue-gradient border-b border-amber-500/30 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div
              class="w-12 h-12 gold-gradient rounded-lg flex items-center justify-center glow"
            >
              <span class="font-racing font-black text-slate-900 text-xl"
                >AC</span
              >
            </div>
            <div>
              <h1 class="font-racing text-2xl font-bold text-amber-400">
                AC ELITE
              </h1>
              <p class="text-xs text-slate-400">Tatuus FA01 Racing League</p>
            </div>
          </div>
          <div class="flex gap-2 flex-wrap">
            <button
              onclick="showPage('stats')"
              id="nav-stats"
              class="nav-btn px-4 py-2 rounded-lg font-semibold transition-all hover:bg-amber-500/20 text-amber-400 border border-amber-500/50"
            >
              üìä Stats
            </button>
            <button
              onclick="showPage('leaderboard')"
              id="nav-leaderboard"
              class="nav-btn px-4 py-2 rounded-lg font-semibold transition-all hover:bg-amber-500/20 text-slate-400 border border-slate-700"
            >
              üèÜ Leaderboard
            </button>
            <button
              onclick="showPage('shop')"
              id="nav-shop"
              class="nav-btn px-4 py-2 rounded-lg font-semibold transition-all hover:bg-amber-500/20 text-slate-400 border border-slate-700"
            >
              üõí Setup Shop
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Loading Overlay -->
    <div
      id="loading-overlay"
      class="fixed inset-0 bg-slate-950/90 z-[100] flex items-center justify-center"
    >
      <div class="text-center">
        <div
          class="w-16 h-16 border-4 border-amber-500/30 border-t-amber-500 rounded-full animate-spin mb-4 mx-auto"
        ></div>
        <p class="font-racing text-amber-400 text-xl">Loading Data...</p>
        <p class="text-slate-500 text-sm mt-2" id="loading-status">
          Fetching from GitHub...
        </p>
      </div>
    </div>

    <!-- Hero Banner -->
    <div class="blue-gradient py-8 border-b border-amber-500/20">
      <div class="max-w-7xl mx-auto px-4 text-center">
        <p class="text-slate-400 mb-2">
          Weekly Track Rotation ‚Ä¢ Vote on Discord ‚Ä¢ Compete for Glory
        </p>
        <div
          id="data-status"
          class="inline-flex items-center gap-2 bg-slate-800/50 px-4 py-2 rounded-full border border-slate-700"
        >
          <span class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></span>
          <span class="text-sm text-yellow-300">Loading...</span>
        </div>
      </div>
    </div>

    <!-- Stats Page -->
    <div id="page-stats" class="page max-w-7xl mx-auto px-4 py-8">
      <div class="mb-8">
        <h2 class="font-racing text-3xl font-bold text-amber-400 mb-4">
          Driver Statistics
        </h2>
        <div class="flex gap-4 items-end flex-wrap">
          <div class="flex-1 min-w-[250px] autocomplete-container">
            <label class="block text-slate-400 text-sm mb-2"
              >Search Driver (Steam Name or GUID)</label
            >
            <input
              type="text"
              id="driver-search"
              placeholder="Start typing driver name..."
              class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-amber-500 focus:outline-none"
              autocomplete="off"
            />
            <div id="autocomplete-results" class="autocomplete-results"></div>
          </div>
          <button
            onclick="searchDriver()"
            class="gold-gradient text-slate-900 font-bold px-6 py-3 rounded-lg hover:opacity-90 transition-opacity glow"
          >
            üîç Search
          </button>
        </div>

        <div
          id="quick-stats"
          class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4"
        >
          <div
            class="bg-slate-900/50 border border-slate-800 rounded-lg p-4 text-center"
          >
            <p class="text-3xl font-racing text-amber-400" id="total-drivers">
              -
            </p>
            <p class="text-slate-500 text-sm">Total Drivers</p>
          </div>
          <div
            class="bg-slate-900/50 border border-slate-800 rounded-lg p-4 text-center"
          >
            <p class="text-3xl font-racing text-blue-400" id="total-tracks">
              -
            </p>
            <p class="text-slate-500 text-sm">Active Tracks</p>
          </div>
          <div
            class="bg-slate-900/50 border border-slate-800 rounded-lg p-4 text-center"
          >
            <p class="text-3xl font-racing text-green-400" id="total-laps">-</p>
            <p class="text-slate-500 text-sm">Total Lap Times</p>
          </div>
          <div
            class="bg-slate-900/50 border border-slate-800 rounded-lg p-4 text-center"
          >
            <p class="text-3xl font-racing text-purple-400" id="total-km">-</p>
            <p class="text-slate-500 text-sm">Total KM Driven</p>
          </div>
        </div>
      </div>

      <div id="driver-stats" class="hidden">
        <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 mb-6">
          <div class="flex items-center justify-between flex-wrap gap-4">
            <div class="flex items-center gap-4">
              <div
                class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center text-3xl"
              >
                üèéÔ∏è
              </div>
              <div>
                <h3
                  id="driver-name"
                  class="font-racing text-2xl font-bold text-white"
                >
                  Driver Name
                </h3>
                <p id="driver-guid" class="text-slate-500 text-sm font-mono">
                  GUID: 76561198000000000
                </p>
              </div>
            </div>
            <div class="text-right">
              <div
                id="driver-licence"
                class="licence-gold text-slate-900 font-bold px-4 py-2 rounded-lg inline-block mb-2"
              >
                Gold Licence
              </div>
              <p id="driver-score" class="text-slate-400 text-sm">
                Score: 523.45
              </p>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
          <div
            class="bg-slate-900 border border-slate-800 rounded-xl p-6 hover:border-amber-500/50 transition-all"
          >
            <div class="flex items-center justify-between mb-2">
              <span class="text-slate-400 text-sm">Balance</span
              ><span class="text-2xl">üí∞</span>
            </div>
            <p
              id="stat-points"
              class="font-racing text-4xl font-bold text-green-400"
            >
              $0
            </p>
            <p class="text-slate-500 text-sm mt-1">Total earnings</p>
          </div>
          <div
            class="bg-slate-900 border border-slate-800 rounded-xl p-6 hover:border-amber-500/50 transition-all"
          >
            <div class="flex items-center justify-between mb-2">
              <span class="text-slate-400 text-sm">Wins</span
              ><span class="text-2xl">ü•á</span>
            </div>
            <p
              id="stat-wins"
              class="font-racing text-4xl font-bold text-amber-400"
            >
              0
            </p>
            <p id="stat-winrate" class="text-slate-500 text-sm mt-1">
              0% win rate
            </p>
          </div>
          <div
            class="bg-slate-900 border border-slate-800 rounded-xl p-6 hover:border-amber-500/50 transition-all"
          >
            <div class="flex items-center justify-between mb-2">
              <span class="text-slate-400 text-sm">Podiums</span
              ><span class="text-2xl">üèÜ</span>
            </div>
            <p
              id="stat-podiums"
              class="font-racing text-4xl font-bold text-white"
            >
              0
            </p>
            <p id="stat-podiumrate" class="text-slate-500 text-sm mt-1">
              0% podium rate
            </p>
          </div>
          <div
            class="bg-slate-900 border border-slate-800 rounded-xl p-6 hover:border-amber-500/50 transition-all"
          >
            <div class="flex items-center justify-between mb-2">
              <span class="text-slate-400 text-sm">Distance</span
              ><span class="text-2xl">üõ£Ô∏è</span>
            </div>
            <p
              id="stat-km"
              class="font-racing text-4xl font-bold text-blue-400"
            >
              0 km
            </p>
            <p class="text-slate-500 text-sm mt-1">Total driven</p>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-slate-900 border border-slate-800 rounded-xl p-6">
            <h3 class="font-racing text-xl font-bold text-amber-400 mb-4">
              üèÅ Performance Stats
            </h3>
            <div class="space-y-4">
              <div
                class="flex justify-between items-center py-3 border-b border-slate-800"
              >
                <span class="text-slate-400">Pole Positions</span>
                <span id="stat-poles" class="font-mono text-amber-400 font-bold"
                  >0</span
                >
              </div>
              <div
                class="flex justify-between items-center py-3 border-b border-slate-800"
              >
                <span class="text-slate-400">Fastest Laps</span>
                <span
                  id="stat-flaps"
                  class="font-mono text-purple-400 font-bold"
                  >0</span
                >
              </div>
              <div
                class="flex justify-between items-center py-3 border-b border-slate-800"
              >
                <span class="text-slate-400">Races Completed</span>
                <span id="stat-races" class="font-mono text-white font-bold"
                  >0</span
                >
              </div>
              <div class="flex justify-between items-center py-3">
                <span class="text-slate-400">Laps Completed</span>
                <span id="stat-laps" class="font-mono text-white font-bold"
                  >0</span
                >
              </div>
            </div>
          </div>

          <div class="bg-slate-900 border border-slate-800 rounded-xl p-6">
            <h3 class="font-racing text-xl font-bold text-amber-400 mb-4">
              ‚ö†Ô∏è Incidents & Safety
            </h3>
            <div class="space-y-4">
              <div
                class="flex justify-between items-center py-3 border-b border-slate-800"
              >
                <span class="text-slate-400">Total Crashes</span>
                <span id="stat-crashes" class="font-mono text-red-400 font-bold"
                  >0</span
                >
              </div>
              <div
                class="flex justify-between items-center py-3 border-b border-slate-800"
              >
                <span class="text-slate-400">Crashes per 100km</span>
                <span
                  id="stat-cr100"
                  class="font-mono text-orange-400 font-bold"
                  >0.00</span
                >
              </div>
              <div
                class="flex justify-between items-center py-3 border-b border-slate-800"
              >
                <span class="text-slate-400">Infractions</span>
                <span id="stat-infr" class="font-mono text-yellow-400 font-bold"
                  >0</span
                >
              </div>
              <div class="flex justify-between items-center py-3">
                <span class="text-slate-400">Infractions per 100km</span>
                <span
                  id="stat-infr100"
                  class="font-mono text-yellow-400 font-bold"
                  >0.00</span
                >
              </div>
            </div>
          </div>
        </div>

        <div class="mt-6 bg-slate-900 border border-slate-800 rounded-xl p-6">
          <h3 class="font-racing text-xl font-bold text-amber-400 mb-4">
            üìú Licence System
          </h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div
              class="text-center p-4 rounded-lg bg-slate-800/50 border border-slate-700"
            >
              <div
                class="licence-platinum text-slate-900 font-bold px-3 py-1 rounded inline-block mb-2 text-sm"
              >
                Platinum
              </div>
              <p class="text-slate-400 text-sm">Score ‚â• 700</p>
            </div>
            <div
              class="text-center p-4 rounded-lg bg-slate-800/50 border border-slate-700"
            >
              <div
                class="licence-gold text-slate-900 font-bold px-3 py-1 rounded inline-block mb-2 text-sm"
              >
                Gold
              </div>
              <p class="text-slate-400 text-sm">Score ‚â• 500</p>
            </div>
            <div
              class="text-center p-4 rounded-lg bg-slate-800/50 border border-slate-700"
            >
              <div
                class="licence-silver text-slate-900 font-bold px-3 py-1 rounded inline-block mb-2 text-sm"
              >
                Silver
              </div>
              <p class="text-slate-400 text-sm">Score ‚â• 200</p>
            </div>
            <div
              class="text-center p-4 rounded-lg bg-slate-800/50 border border-slate-700"
            >
              <div
                class="licence-bronze text-slate-900 font-bold px-3 py-1 rounded inline-block mb-2 text-sm"
              >
                Bronze
              </div>
              <p class="text-slate-400 text-sm">Score ‚â• 0</p>
            </div>
          </div>
        </div>
      </div>

      <div id="no-driver" class="text-center py-16">
        <div class="text-6xl mb-4">üîç</div>
        <h3 class="font-racing text-xl text-slate-400 mb-2">
          Search for a driver
        </h3>
        <p class="text-slate-500">
          Enter a driver name or Steam64 ID to view their statistics
        </p>
      </div>
    </div>

    <!-- Leaderboard Page -->
    <div id="page-leaderboard" class="page hidden max-w-7xl mx-auto px-4 py-8">
      <h2 class="font-racing text-3xl font-bold text-amber-400 mb-2">
        üèÜ KMR Leaderboard
      </h2>
      <p class="text-slate-400 mb-6">
        Track times for Tatuus FA01 ‚Ä¢ Data synced from KissMyRank
      </p>

      <div class="mb-6">
        <label class="block text-slate-400 text-sm mb-2">Select Track</label>
        <div class="flex flex-wrap gap-2" id="track-buttons"></div>
      </div>

      <div
        class="bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 mb-6 flex items-center justify-between flex-wrap gap-2"
      >
        <div>
          <span class="text-slate-400 text-sm">Current Track:</span>
          <span id="current-track" class="font-racing text-amber-400 ml-2"
            >-</span
          >
        </div>
        <div>
          <span class="text-slate-400 text-sm">Car:</span>
          <span class="font-mono text-white ml-2">tatuusfa1</span>
        </div>
        <div>
          <span class="text-slate-400 text-sm">Entries:</span>
          <span id="entry-count" class="font-mono text-green-400 ml-2">0</span>
        </div>
      </div>

      <div
        class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden"
      >
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="text-left text-slate-400 text-sm bg-slate-800/50">
                <th class="py-4 px-4 w-16">Pos</th>
                <th class="py-4 px-4">Driver</th>
                <th class="py-4 px-4">Lap Time</th>
                <th class="py-4 px-4">Gap</th>
              </tr>
            </thead>
            <tbody id="leaderboard-body"></tbody>
          </table>
        </div>
      </div>

      <div class="mt-6 flex justify-center gap-2" id="pagination"></div>

      <div id="no-leaderboard" class="hidden text-center py-16">
        <div class="text-6xl mb-4">üìä</div>
        <h3 class="font-racing text-xl text-slate-400 mb-2">
          No lap times recorded
        </h3>
        <p class="text-slate-500">Select a track to view the leaderboard</p>
      </div>
    </div>

    <!-- Setup Shop Page -->
    <div id="page-shop" class="page hidden max-w-7xl mx-auto px-4 py-8">
      <h2 class="font-racing text-3xl font-bold text-amber-400 mb-2">
        üõí Setup Shop
      </h2>
      <p class="text-slate-400 mb-6">
        Premium Tatuus FA01 setups for every track in rotation
      </p>

      <div class="mb-6 flex flex-wrap gap-2">
        <button
          onclick="filterShop('all')"
          class="shop-btn active px-4 py-2 rounded-lg font-semibold bg-amber-500 text-slate-900"
          data-track="all"
        >
          All Tracks
        </button>
        <button
          onclick="filterShop('ks_zandvoort')"
          class="shop-btn px-4 py-2 rounded-lg font-semibold bg-slate-800 text-slate-300 hover:bg-slate-700"
          data-track="ks_zandvoort"
        >
          Zandvoort
        </button>
        <button
          onclick="filterShop('spa')"
          class="shop-btn px-4 py-2 rounded-lg font-semibold bg-slate-800 text-slate-300 hover:bg-slate-700"
          data-track="spa"
        >
          Spa
        </button>
        <button
          onclick="filterShop('ks_silverstone')"
          class="shop-btn px-4 py-2 rounded-lg font-semibold bg-slate-800 text-slate-300 hover:bg-slate-700"
          data-track="ks_silverstone"
        >
          Silverstone
        </button>
        <button
          onclick="filterShop('ks_monza66')"
          class="shop-btn px-4 py-2 rounded-lg font-semibold bg-slate-800 text-slate-300 hover:bg-slate-700"
          data-track="ks_monza66"
        >
          Monza
        </button>
        <button
          onclick="filterShop('imola')"
          class="shop-btn px-4 py-2 rounded-lg font-semibold bg-slate-800 text-slate-300 hover:bg-slate-700"
          data-track="imola"
        >
          Imola
        </button>
      </div>

      <div
        id="shop-grid"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
      ></div>
    </div>

    <!-- Footer -->
    <footer class="border-t border-slate-800 mt-12 py-8">
      <div class="max-w-7xl mx-auto px-4 text-center">
        <div class="flex items-center justify-center gap-3 mb-4">
          <div
            class="w-8 h-8 gold-gradient rounded-lg flex items-center justify-center"
          >
            <span class="font-racing font-black text-slate-900 text-sm"
              >AC</span
            >
          </div>
          <span class="font-racing text-lg text-amber-400">AC ELITE</span>
        </div>
        <p class="text-slate-500 text-sm">
          Vote for next week's track on Discord ‚Ä¢ Tatuus FA01 Racing League
        </p>
        <p class="text-slate-600 text-xs mt-2" id="last-sync">
          Data synced via GitHub Actions
        </p>
      </div>
    </footer>

    <script>
      /* ===================== CONFIGURATION ===================== */

      // Base URL for data files - UPDATE THIS with your GitHub username and repo name!
      const GITHUB_USER = "xstellaa10";
      const GITHUB_REPO = "xstellaa10.github.io";
      const DATA_BASE_URL = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/data`;

      // Alternative: If using GitHub Pages, you can use relative paths
      // const DATA_BASE_URL = "./data";

      const CAR = "tatuusfa1";

      let leaderboardData = {};
      let rankData = [];
      let metadata = {};
      let dataLoaded = false;

      /* ===================== DATA FETCHING ===================== */

      async function fetchJSON(filename) {
        const url = `${DATA_BASE_URL}/${filename}?t=${Date.now()}`; // Cache bust
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      }

      async function loadAllData() {
        showLoading(true);
        updateLoadingStatus("Fetching data from GitHub...");

        try {
          // Fetch all data in parallel
          const [rankResult, leaderboardResult, metadataResult] =
            await Promise.allSettled([
              fetchJSON("rank.json"),
              fetchJSON("leaderboard.json"),
              fetchJSON("metadata.json"),
            ]);

          if (rankResult.status === "fulfilled") {
            rankData = rankResult.value;
            console.log("[DATA] Rank loaded:", rankData.length, "drivers");
          }

          if (leaderboardResult.status === "fulfilled") {
            leaderboardData = leaderboardResult.value;
            console.log(
              "[DATA] Leaderboard loaded:",
              Object.keys(leaderboardData).length,
              "tracks"
            );
          }

          if (metadataResult.status === "fulfilled") {
            metadata = metadataResult.value;
            console.log("[DATA] Metadata loaded:", metadata);
          }

          dataLoaded =
            rankData.length > 0 || Object.keys(leaderboardData).length > 0;

          showLoading(false);
          updateDataStatus(dataLoaded);
          updateQuickStats();
          updateLastSync();
        } catch (err) {
          console.error("Failed to load data:", err);
          showLoading(false);
          updateDataStatus(false);
        }

        return dataLoaded;
      }

      function showLoading(show) {
        document
          .getElementById("loading-overlay")
          .classList.toggle("hidden", !show);
      }

      function updateLoadingStatus(text) {
        document.getElementById("loading-status").textContent = text;
      }

      function updateDataStatus(success) {
        const status = document.getElementById("data-status");
        if (success) {
          status.innerHTML =
            '<span class="w-2 h-2 bg-green-500 rounded-full"></span><span class="text-sm text-slate-300">Live Data ‚Ä¢ Synced via GitHub</span>';
        } else {
          status.innerHTML =
            '<span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span><span class="text-sm text-red-300">Failed to load data</span>';
        }
      }

      function updateLastSync() {
        if (metadata.lastSync) {
          const date = new Date(metadata.lastSync);
          const formatted = date.toLocaleString();
          document.getElementById(
            "last-sync"
          ).textContent = `Last synced: ${formatted}`;
        }
      }

      function updateQuickStats() {
        document.getElementById("total-drivers").textContent =
          rankData.length.toLocaleString();
        document.getElementById("total-tracks").textContent =
          Object.keys(leaderboardData).length;

        let totalLaps = 0;
        Object.values(leaderboardData).forEach((track) => {
          Object.values(track).forEach((car) => {
            totalLaps += car.length;
          });
        });
        document.getElementById("total-laps").textContent =
          totalLaps.toLocaleString();

        const totalKm = rankData.reduce(
          (sum, d) => sum + (d.kilometers || 0),
          0
        );
        document.getElementById("total-km").textContent =
          Math.round(totalKm).toLocaleString();
      }

      /* ===================== TRACK NAMES ===================== */

      const trackNames = {
        ks_zandvoort: "Zandvoort",
        spa: "Spa-Francorchamps",
        ks_silverstone: "Silverstone",
        ks_monza66: "Monza",
        imola: "Imola",
        ks_nurburgring_layout_gp_a: "N√ºrburgring GP",
        "ks_red_bull_ring-layout_gp": "Red Bull Ring",
        ks_brands_hatch: "Brands Hatch",
        "ks_barcelona-layout_gp": "Barcelona",
        ks_hungaroring: "Hungaroring",
        mugello: "Mugello",
      };

      function getTrackDisplayName(trackId) {
        return (
          trackNames[trackId] || trackId.replace(/_/g, " ").replace(/-/g, " ")
        );
      }

      /* ===================== SETUP SHOP ===================== */

      const setups = [
        {
          id: 1,
          track: "ks_zandvoort",
          name: "Zandvoort Banking Special",
          author: "MaxSpeed_Pro",
          rating: 4.9,
          price: 550,
          description: "Optimized for the banked corners.",
        },
        {
          id: 2,
          track: "ks_zandvoort",
          name: "Zandvoort All-Rounder",
          author: "DutchRacer",
          rating: 4.7,
          price: 400,
          description: "Great balance for quali and race.",
        },
        {
          id: 3,
          track: "spa",
          name: "Spa Quali Beast",
          author: "SpaKing_Pro",
          rating: 4.9,
          price: 600,
          description: "Low downforce, max speed through Eau Rouge.",
        },
        {
          id: 4,
          track: "spa",
          name: "Spa Race Setup",
          author: "RacerX_Elite",
          rating: 4.7,
          price: 450,
          description: "Balanced setup with good tire preservation.",
        },
        {
          id: 5,
          track: "ks_silverstone",
          name: "Silverstone Fast Sectors",
          author: "BritishRacer",
          rating: 4.9,
          price: 600,
          description: "Built for the high-speed sections.",
        },
        {
          id: 6,
          track: "ks_monza66",
          name: "Monza Speedtrap King",
          author: "ItalianSpeed",
          rating: 4.8,
          price: 500,
          description: "Lowest drag setup. 310+ km/h guaranteed.",
        },
        {
          id: 7,
          track: "imola",
          name: "Imola Technical Master",
          author: "ImolaKing",
          rating: 4.7,
          price: 550,
          description: "Great traction out of slow corners.",
        },
      ];

      /* ===================== SCORE CALCULATION ===================== */

      function calculateScore(d) {
        const km = Math.max(1, d.kilometers ?? 0);
        const winRate = (d.wins ?? 0) / (km / 1000);
        const podiumRate = (d.podiums ?? 0) / (km / 1000);
        const poleRate = (d.poles ?? 0) / (km / 1000);
        const flapRate = (d.flaps ?? 0) / (km / 1000);
        const enduranceBonus = Math.log10(km);
        return (
          winRate * 30 +
          podiumRate * 20 +
          poleRate * 15 +
          flapRate * 12 +
          enduranceBonus * 10 +
          (d.points ?? 0) * 0.05 -
          (d.infr ?? 0) * 1.5 -
          (d.crashes ?? 0) * 2.0 -
          (d.infr_per_100km ?? 0) * 25 -
          (d.cr_per_100km ?? 0) * 30
        );
      }

      function getLicence(score) {
        if (score >= 700)
          return { name: "Platinum Licence", class: "licence-platinum" };
        if (score >= 500)
          return { name: "Gold Licence", class: "licence-gold" };
        if (score >= 200)
          return { name: "Silver Licence", class: "licence-silver" };
        return { name: "Bronze Licence", class: "licence-bronze" };
      }

      function formatLaptime(ms) {
        const min = Math.floor(ms / 60000);
        const sec = ((ms / 1000) % 60).toFixed(3).padStart(6, "0");
        return `${min}:${sec}`;
      }

      function calculateGap(fastestLap, currentLap) {
        if (fastestLap === currentLap) return "-";
        return `+${((currentLap - fastestLap) / 1000).toFixed(3)}`;
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      /* ===================== NAVIGATION ===================== */

      let currentTrack = null;
      let currentPage = 1;
      const itemsPerPage = 15;
      let currentShopFilter = "all";

      function showPage(page) {
        document
          .querySelectorAll(".page")
          .forEach((p) => p.classList.add("hidden"));
        document.getElementById(`page-${page}`).classList.remove("hidden");

        document.querySelectorAll(".nav-btn").forEach((btn) => {
          btn.classList.remove("text-amber-400", "border-amber-500/50");
          btn.classList.add("text-slate-400", "border-slate-700");
        });
        document
          .getElementById(`nav-${page}`)
          .classList.remove("text-slate-400", "border-slate-700");
        document
          .getElementById(`nav-${page}`)
          .classList.add("text-amber-400", "border-amber-500/50");

        if (page === "leaderboard") {
          renderTrackButtons();
          if (!currentTrack && Object.keys(leaderboardData).length > 0) {
            selectTrack(Object.keys(leaderboardData)[0]);
          }
        }
        if (page === "shop") renderShop();
      }

      /* ===================== AUTOCOMPLETE ===================== */

      const searchInput = document.getElementById("driver-search");
      const autocompleteResults = document.getElementById(
        "autocomplete-results"
      );
      let autocompleteTimeout;

      searchInput.addEventListener("input", function () {
        clearTimeout(autocompleteTimeout);
        const query = this.value.trim().toLowerCase();

        if (query.length < 2) {
          autocompleteResults.classList.remove("show");
          return;
        }

        autocompleteTimeout = setTimeout(() => {
          const matches = rankData
            .filter(
              (d) =>
                d.name.toLowerCase().includes(query) || d.guid.includes(query)
            )
            .slice(0, 8);
          if (matches.length === 0) {
            autocompleteResults.classList.remove("show");
            return;
          }

          autocompleteResults.innerHTML = matches
            .map(
              (d) => `
                    <div class="autocomplete-item" onclick="selectDriver('${
                      d.guid
                    }')">
                        <div class="autocomplete-name">${escapeHtml(
                          d.name
                        )}</div>
                        <div class="autocomplete-guid">${d.guid}</div>
                    </div>
                `
            )
            .join("");
          autocompleteResults.classList.add("show");
        }, 150);
      });

      searchInput.addEventListener("keyup", (e) => {
        if (e.key === "Enter") {
          autocompleteResults.classList.remove("show");
          searchDriver();
        }
      });
      document.addEventListener("click", (e) => {
        if (!e.target.closest(".autocomplete-container"))
          autocompleteResults.classList.remove("show");
      });

      function selectDriver(guid) {
        const driver = rankData.find((d) => d.guid === guid);
        if (driver) {
          searchInput.value = driver.name;
          autocompleteResults.classList.remove("show");
          displayDriverStats(driver);
        }
      }

      /* ===================== STATS PAGE ===================== */

      function searchDriver() {
        const query = document
          .getElementById("driver-search")
          .value.trim()
          .toLowerCase();
        if (!query) return;

        const driver = rankData.find(
          (d) => d.name.toLowerCase().includes(query) || d.guid.includes(query)
        );

        if (!driver) {
          document.getElementById("driver-stats").classList.add("hidden");
          document.getElementById("no-driver").classList.remove("hidden");
          document.getElementById(
            "no-driver"
          ).innerHTML = `<div class="text-6xl mb-4">‚ùå</div><h3 class="font-racing text-xl text-slate-400 mb-2">Driver not found</h3><p class="text-slate-500">No driver matches "${escapeHtml(
            query
          )}"</p>`;
          return;
        }
        displayDriverStats(driver);
      }

      function displayDriverStats(driver) {
        document.getElementById("no-driver").classList.add("hidden");
        document.getElementById("driver-stats").classList.remove("hidden");

        const score = calculateScore(driver);
        const licence = getLicence(score);
        const races = driver.races || 0;
        const winRate =
          races > 0 ? ((driver.wins / races) * 100).toFixed(1) : 0;
        const podiumRate =
          races > 0 ? ((driver.podiums / races) * 100).toFixed(1) : 0;

        document.getElementById("driver-name").textContent = driver.name;
        document.getElementById(
          "driver-guid"
        ).textContent = `GUID: ${driver.guid}`;
        document.getElementById("driver-licence").textContent = licence.name;
        document.getElementById(
          "driver-licence"
        ).className = `${licence.class} text-slate-900 font-bold px-4 py-2 rounded-lg inline-block mb-2`;
        document.getElementById(
          "driver-score"
        ).textContent = `Score: ${score.toFixed(2)}`;
        document.getElementById("stat-points").textContent = `$${(
          driver.points || 0
        ).toLocaleString()}`;
        document.getElementById("stat-wins").textContent = driver.wins || 0;
        document.getElementById(
          "stat-winrate"
        ).textContent = `${winRate}% win rate`;
        document.getElementById("stat-podiums").textContent =
          driver.podiums || 0;
        document.getElementById(
          "stat-podiumrate"
        ).textContent = `${podiumRate}% podium rate`;
        document.getElementById("stat-km").textContent = `${(
          driver.kilometers || 0
        ).toFixed(1)} km`;
        document.getElementById("stat-poles").textContent = driver.poles || 0;
        document.getElementById("stat-flaps").textContent = driver.flaps || 0;
        document.getElementById("stat-races").textContent = driver.races || 0;
        document.getElementById("stat-laps").textContent = (
          driver.laps || 0
        ).toLocaleString();
        document.getElementById("stat-crashes").textContent =
          driver.crashes || 0;
        document.getElementById("stat-cr100").textContent = (
          driver.cr_per_100km || 0
        ).toFixed(2);
        document.getElementById("stat-infr").textContent = driver.infr || 0;
        document.getElementById("stat-infr100").textContent = (
          driver.infr_per_100km || 0
        ).toFixed(2);
      }

      /* ===================== LEADERBOARD ===================== */

      function renderTrackButtons() {
        const container = document.getElementById("track-buttons");
        const tracks = Object.keys(leaderboardData).sort();
        if (tracks.length === 0) {
          container.innerHTML =
            '<p class="text-slate-500">No tracks available</p>';
          return;
        }
        container.innerHTML = tracks
          .map(
            (track) => `
                <button onclick="selectTrack('${track}')" class="track-btn px-4 py-2 rounded-lg font-semibold transition-all ${
              currentTrack === track
                ? "bg-amber-500 text-slate-900"
                : "bg-slate-800 text-slate-300 hover:bg-slate-700"
            }">${getTrackDisplayName(track)}</button>
            `
          )
          .join("");
      }

      function selectTrack(track) {
        currentTrack = track;
        currentPage = 1;
        renderTrackButtons();
        renderLeaderboard();
      }

      function renderLeaderboard() {
        if (!currentTrack || !leaderboardData[currentTrack]) {
          document.getElementById("no-leaderboard").classList.remove("hidden");
          document.getElementById("leaderboard-body").innerHTML = "";
          document.getElementById("pagination").innerHTML = "";
          return;
        }

        document.getElementById("no-leaderboard").classList.add("hidden");
        document.getElementById("current-track").textContent =
          getTrackDisplayName(currentTrack);

        const carData = leaderboardData[currentTrack][CAR] || [];
        const sorted = [...carData].sort((a, b) => a.laptime - b.laptime);
        document.getElementById("entry-count").textContent = sorted.length;

        const totalPages = Math.ceil(sorted.length / itemsPerPage);
        const start = (currentPage - 1) * itemsPerPage;
        const paginated = sorted.slice(start, start + itemsPerPage);
        const fastestLap = sorted.length > 0 ? sorted[0].laptime : 0;

        const tbody = document.getElementById("leaderboard-body");
        if (sorted.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" class="py-8 text-center text-slate-500">No lap times recorded for ${CAR} on this track</td></tr>`;
          document.getElementById("pagination").innerHTML = "";
          return;
        }

        tbody.innerHTML = paginated
          .map((entry, index) => {
            const pos = start + index + 1;
            let rowClass = "",
              posClass = "bg-slate-700 text-slate-300",
              medal = "";
            if (pos === 1) {
              rowClass = "top1";
              posClass = "bg-yellow-500 text-slate-900 font-bold";
              medal = " ü•á";
            } else if (pos === 2) {
              rowClass = "top2";
              posClass = "bg-slate-400 text-slate-900 font-bold";
              medal = " ü•à";
            } else if (pos === 3) {
              rowClass = "top3";
              posClass = "bg-amber-600 text-slate-900 font-bold";
              medal = " ü•â";
            } else if (pos <= 10) {
              rowClass = "top10";
              posClass = "bg-blue-600 text-white";
            }

            return `<tr class="border-b border-slate-800/50 hover:bg-slate-800/30 transition-all ${rowClass}">
                    <td class="py-3 px-4"><span class="px-2 py-1 rounded text-sm ${posClass}">${pos}</span></td>
                    <td class="py-3 px-4 font-semibold">${escapeHtml(
                      entry.name?.slice(0, 30) || "Unknown"
                    )}${medal}</td>
                    <td class="py-3 px-4 font-mono text-amber-400 font-bold">${formatLaptime(
                      entry.laptime
                    )}</td>
                    <td class="py-3 px-4 font-mono text-slate-400">${calculateGap(
                      fastestLap,
                      entry.laptime
                    )}</td>
                </tr>`;
          })
          .join("");

        const pagination = document.getElementById("pagination");
        if (totalPages > 1) {
          let html = `<button onclick="goToPage(${currentPage - 1})" ${
            currentPage === 1 ? "disabled" : ""
          } class="px-3 py-2 rounded bg-slate-800 text-slate-300 hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed">‚Üê</button>`;
          for (let i = 1; i <= totalPages; i++) {
            if (
              i === 1 ||
              i === totalPages ||
              (i >= currentPage - 1 && i <= currentPage + 1)
            ) {
              html += `<button onclick="goToPage(${i})" class="px-3 py-2 rounded ${
                currentPage === i
                  ? "bg-amber-500 text-slate-900"
                  : "bg-slate-800 text-slate-300 hover:bg-slate-700"
              }">${i}</button>`;
            } else if (i === currentPage - 2 || i === currentPage + 2) {
              html += `<span class="px-2 text-slate-500">...</span>`;
            }
          }
          html += `<button onclick="goToPage(${currentPage + 1})" ${
            currentPage === totalPages ? "disabled" : ""
          } class="px-3 py-2 rounded bg-slate-800 text-slate-300 hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed">‚Üí</button>`;
          pagination.innerHTML = html;
        } else {
          pagination.innerHTML = "";
        }
      }

      function goToPage(page) {
        const carData = leaderboardData[currentTrack]?.[CAR] || [];
        const totalPages = Math.ceil(carData.length / itemsPerPage);
        if (page >= 1 && page <= totalPages) {
          currentPage = page;
          renderLeaderboard();
        }
      }

      /* ===================== SHOP ===================== */

      function filterShop(track) {
        currentShopFilter = track;
        document.querySelectorAll(".shop-btn").forEach((btn) => {
          btn.classList.remove("bg-amber-500", "text-slate-900");
          btn.classList.add("bg-slate-800", "text-slate-300");
        });
        document
          .querySelector(`.shop-btn[data-track="${track}"]`)
          ?.classList.remove("bg-slate-800", "text-slate-300");
        document
          .querySelector(`.shop-btn[data-track="${track}"]`)
          ?.classList.add("bg-amber-500", "text-slate-900");
        renderShop();
      }

      function renderShop() {
        const filtered =
          currentShopFilter === "all"
            ? setups
            : setups.filter((item) => item.track === currentShopFilter);
        const grid = document.getElementById("shop-grid");
        grid.innerHTML = filtered
          .map(
            (setup) => `
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 hover:border-amber-500/50 transition-all group">
                    <div class="flex items-start justify-between mb-3">
                        <span class="text-xs bg-blue-900/50 text-blue-300 px-2 py-1 rounded">${getTrackDisplayName(
                          setup.track
                        )}</span>
                        <div class="flex items-center gap-1 text-amber-400"><span>‚òÖ</span><span class="text-sm">${
                          setup.rating
                        }</span></div>
                    </div>
                    <h3 class="font-racing text-lg font-bold text-white mb-1 group-hover:text-amber-400 transition-colors">${escapeHtml(
                      setup.name
                    )}</h3>
                    <p class="text-slate-500 text-sm mb-3">by ${escapeHtml(
                      setup.author
                    )}</p>
                    <p class="text-slate-400 text-sm mb-4">${escapeHtml(
                      setup.description
                    )}</p>
                    <div class="flex items-center justify-between">
                        <span class="font-racing text-xl font-bold text-green-400">$${
                          setup.price
                        }</span>
                        <a href="#" onclick="buySetup(${
                          setup.id
                        }); return false;" class="gold-gradient text-slate-900 font-bold px-4 py-2 rounded-lg hover:opacity-90 transition-opacity glow">Buy Setup</a>
                    </div>
                </div>
            `
          )
          .join("");

        if (filtered.length === 0) {
          grid.innerHTML = `<div class="col-span-full text-center py-12"><div class="text-4xl mb-3">üîß</div><p class="text-slate-400">No setups available for this track yet</p></div>`;
        }
      }

      function buySetup(id) {
        const setup = setups.find((s) => s.id === id);
        alert(`Redirecting to purchase: ${setup.name}\nPrice: $${setup.price}`);
      }

      /* ===================== INIT ===================== */

      document.addEventListener("DOMContentLoaded", async () => {
        await loadAllData();
        renderShop();
      });
    </script>
  </body>
</html>
